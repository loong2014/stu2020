架构
https://blog.csdn.net/weixin_40117614/article/details/97013266

GATT（Generic attribute profile ）。GATT用来规范attribute中的数据内容，并运用group（分组）的概念对attribute进行分类管理。没有GATT，BLE协议栈也能跑，但互联互通就会出问题，也正是因为有了GATT和各种各样的应用profile，BLE摆脱了ZigBee等无线协议的兼容性困境，成了出货量最大的2.4G无线通信产品。

ATT（Attribute protocol）。ATT层用来定义用户命令及命令操作的数据，比如读取某个数据或者写某个数据。BLE协议栈中，开发者接触最多的就是ATT。BLE引入了attribute概念，用来描述一条一条的数据。Attribute除了定义数据，同时定义该数据可以使用的ATT命令，因此这一层被称为ATT层。

SMP（Secure manager protocol）。SMP用来管理BLE连接的加密和安全的，如何保证连接的安全性，同时不影响用户的体验，这些都是SMP要考虑的工作。

L2CAP层（Logic link control and adaptation protocol）。L2CAP对LL进行了一次简单封装，LL只关心传输的数据本身，L2CAP就要区分是加密通道还是普通通道，同时还要对连接间隔进行管理。

GAP层（Generic access profile）。GAP是对LL层payload（有效数据包）进行解析!

HCI（Host controller interface）。HCI是可选的（三种蓝牙架构实现方案（蓝牙协议栈方案）），HCI主要用于2颗芯片实现BLE协议栈的场合，用来规范两者之间的通信协议和通信命令等。

PHY层（Physical layer物理层）。PHY层用来指定BLE所用的无线频段，调制解调方式和方法等。（属于厂家）


1. 一次对多传输多少字节
https://blog.csdn.net/freemote/article/details/120165736

    1、链路层数据包格式
    LLP(Like Layer packet) = 1+4+PDU(2~257)+3


    PDU >>>>
    2、数据通道PDU
    Header：包头，2字节；
    Payload：数据，变长；
    MIC：数据一致性校验，4字节


    Payload >>>>
    3、L2CAP层数据包格式
    Length：长度，2字节；
    Channel ID：信道ID，2字节；
    Information payload：变长。


    Information payload >>>>
    4、Attribute Protocol PDU格式
    Opcode：操作码，1字节；
    Attribute Parameters：ATT参数，变长；
    Authentication Signature：身份验证签名，如果有，则是12字节。

    所以 ATT_MTU 最大长度为257-2（Header）-4（MIC）-2（Length）-2（Channel ID）=247。

    6、ATT层操作符Handle Value Notification（0x1B）
    Attribute Qpcode：长度，1字节 == 0x1B
    Attribute Handle：长度，2字节；
    Attribute Value：长度，0～ATT_MTU-3
    最大长度 = ATT_MTU - 3 = 244

    7、ATT层操作符Signed Write Command（0xD2）
    Attribute Qpcode：长度，1字节 == 0xD2
    Attribute Handle：长度，2字节；
    Attribute Value：长度，0～ATT_MTU-15
    Authentication Signature：身份验证签名，如果有，则是12字节。
    最大长度 = ATT_MTU - 15 = 232

2. BLE 传输速率/数据吞吐量(Data Throughput)
https://www.cnblogs.com/someone-device/p/12131600.html

https://blog.csdn.net/u012408797/article/details/106054224

    低功耗蓝牙 5.0 协议中，定义两种调制方式，
    强制的调制方式(1 Msym/s 调制)使用一个shaped, binary FM去减小传输的复杂度。符号速率是 1 Msym/s，
    另一种可选的调制方案( 2 Msym/s) 是类似的，但使用了 2 Msym/s的符号速率。

    在 1 Msym/s 调制方式支持两种 PHY：
    (1) LE Uncode PHY，传输速率就为 1 Mb/s。
    (2) LE Coded PHY，信息数据编码方式，传输速率为 125 kb/s或者500 kb/s。

    在 2 Msym/s 调制方式下支持单一 PHY：
    LE 2MPHY，信息数据不编码，传输速率就为 2 Mb/s。

    相对于早先的蓝牙协议标准来说，LE Coded PHY 和 LE 2M PHY 是新增加的。
    其中 LE Coded PHY 中引入了 FEC 编解码以及 Pattern Mapper 和 Demapper 部分,
    以降低传输速率，增加接收机复杂度为代价，使得蓝牙设备能更远距离的传输信号，从而更好地适应物联网应用。

    一旦BLE设备建立连接后，两个设备会以相等的时间间隔交换数据，这个间隔成为连接间隔（Connection Interval），间隔范围是7.5ms-4s。
    并且，要交互的数据都发生在Connection Event之间，其余时间处于sleep状态，即使应用层无数据交互，
    整个链路也会以Connection Interval间隔交互数据(空包)，应用层数据多，Connection Event时间就越长，sleep时间就越短。

    连接间隔决定着传输速率，值越小，发送数据越快，但功耗也会越大。假如连接间隔是7.5ms，每个连接间隔可以发送125个字节，那么单向传输速率计算如下：


3. 蓝牙协议版本
https://blog.csdn.net/johnWcheung/article/details/102621964
    传统/低功耗/双模式

4. 编码格式
https://blog.csdn.net/Z_HUALIN/article/details/86525532
SBC （Sub-band coding，子带编码）
ACC（Advanced Audio Coding，高级音频编码）

APTX aptX分为三种：aptX，aptX HD和aptX Low Latency，
根据名字可以认为，分别是传统aptX，高品质aptX（估计是提高码率）和低时间延迟aptX（在看视频和打CS的时候时间延迟就很重要了）。所以aptX其实传输码率估计也不高，可能和前面两者差不多，但是得益于高效的编码，使得声音保留的细节更多，实际听感好于前面两者，aptX的宣传也是称其可以达到CD级别的听感。

LDAC


4. 更改MTU
设备连接成功后 ：onConnectionStateChange 通过 gatt.requestMtu(512) 来设置最大传输字节
设置成功后：onMtuChanged 中再进行 discoverServices

5. 发现服务后进行特征监听，然后需要延时一定时间再进行新的操作
进行特征监听时，处理调用 setCharacteristicNotification 对特征进行enable，还要对特征下的 descriptor 进行设置。
descriptor 对应的UUID = 00002902-0000-1000-8000-00805f9b34fb
    des.value = BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE
    gatt.writeDescriptor(des)



